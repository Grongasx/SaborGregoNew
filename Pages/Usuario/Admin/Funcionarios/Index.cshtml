@page "/admin/funcionarios"
@using SaborGregoNew.Enums
@model SaborGregoNew.Pages.Usuario.Admin.Funcionarios.IndexModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Gerenciar Funcionários";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>@ViewData["Title"]</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEmployeeModal">
            <i class="bi bi-plus-lg"></i> Cadastrar Novo
        </button>
    </div>

    @if (Model.Funcionarios != null && Model.Funcionarios.Any())
    {
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>Cargo</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var funcionario in Model.Funcionarios)
                            {
                                <tr>
                                    <td>@funcionario.Nome</td>
                                    <td>@funcionario.Email</td>
                                    <td>@funcionario.Telefone</td>
                                    <td>
                                        <span class="badge bg-@(funcionario.Role == UserRole.Admin ? "danger" : funcionario.Role == UserRole.Cozinheiro ? "warning" : "info")">
                                            @funcionario.Role
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group">
                                            <a asp-page="./Edit" asp-route-id="@funcionario.Id" class="btn btn-sm btn-outline-secondary" title="Editar">
                                                Editar
                                            </a>
                                            <form method="post" asp-page-handler="Delete" asp-route-id="@funcionario.Id" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir este funcionário?');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir">
                                                    Excluir
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            Nenhum funcionário encontrado.
        </div>
    }
</div>

<!-- Modal -->
<div class="modal fade" id="createEmployeeModal" tabindex="-1" aria-labelledby="createEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEmployeeModalLabel">Cadastrar Funcionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="Create">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <div class="mb-3">
                        <label asp-for="Input.Nome" class="form-label">Nome Completo</label>
                        <input asp-for="Input.Nome" class="form-control" placeholder="Ex: João da Silva" />
                        <span asp-validation-for="Input.Nome" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Input.Email" class="form-label">Email</label>
                        <input asp-for="Input.Email" class="form-control" type="email" placeholder="email@exemplo.com" />
                        <span asp-validation-for="Input.Email" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Input.Telefone" class="form-label">Telefone</label>
                        <input id="telefone" asp-for="Input.Telefone" class="form-control" placeholder="(00) 00000-0000" maxlength="15" />
                        <span asp-validation-for="Input.Telefone" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Input.Senha" class="form-label">Senha</label>
                        <input asp-for="Input.Senha" class="form-control" type="password" />
                        <span asp-validation-for="Input.Senha" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Input.Role" class="form-label">Cargo</label>
                        <select asp-for="Input.Role" class="form-select" asp-items="Model.Roles">
                            <option value="">Selecione um cargo...</option>
                        </select>
                        <span asp-validation-for="Input.Role" class="text-danger"></span>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Cadastrar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var hasErrors = document.querySelector('.validation-summary-errors') !== null || document.querySelector('.field-validation-error') !== null;
            
            // Also check if Input has values (meaning it was a postback), but checking errors is usually enough for "re-opening" logic.
            // If the user just opened the page, there are no errors.
            
            if (hasErrors) {
                var myModal = new bootstrap.Modal(document.getElementById('createEmployeeModal'));
                myModal.show();
            }
        });

        // Função que aplica a máscara
        const handlePhone = (event) => {
            let input = event.target
            input.value = phoneMask(input.value)
        }

        const phoneMask = (value) => {
            if (!value) return ""
            value = value.replace(/\D/g,'')
            value = value.replace(/(\d{2})(\d)/,"($1) $2")
            value = value.replace(/(\d)(\d{4})$/,"$1-$2")
            return value
        }
        const inputTelefone = document.getElementById('telefone');

        if(inputTelefone) {
            inputTelefone.addEventListener('keyup', handlePhone);
        }
    </script>
}
